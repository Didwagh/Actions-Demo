name: deployment
on: push

jobs:
  # Job 1: Backend Server Only
  # backend_server:
  #   runs-on: ubuntu-latest
  #   outputs:
      # backend_url: ${{ steps.start-backend.outputs.url }}
  #   steps:
  #     - name: Checkout repo
  #       uses: actions/checkout@v4
       
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '18'
       
  #     - name: Install dependencies
  #       run: npm install

  #     - name: Get LocalTunnel Password
  #       run: |
  #         echo "ðŸ”‘ Getting password from LocalTunnel..."
  #         curl -s https://loca.lt/mytunnelpassword
  #         echo ""
  #         echo "ðŸ‘† Copy the password shown above"
       
  #     - name: Start backend server
  #       id: start-backend
  #       run: |
  #         echo "ðŸš€ Starting backend server..."
  #         node server.js > server.log 2>&1 &
  #         sleep 15
  #         cat server.log
  #         url=$(grep -o 'https://[0-9a-z-]\+\.loca\.lt' server.log | head -n1)
  #         echo "Backend URL captured: $url"
  #         echo "url=$url" >> $GITHUB_OUTPUT
       
  #     - name: Test backend API
  #       run: |
  #         echo "ðŸ§ª Testing backend API..."
  #         curl -s ${{ steps.start-backend.outputs.url }}/api
  #         echo ""
  #         echo "âœ… Backend API is working!"
       
  #     - name: Keep backend alive
  #       run: |
  #         echo "ðŸ”„ Keeping backend alive for 10 minutes..."
  #         sleep 600

  # Job 2: Frontend Host (runs after backend is ready)
  frontend_host:
    runs-on: ubuntu-latest
    steps:
      # - name: sleeping till backend runs 
      #   run: |
      #     echo "ðŸ”„ Keeping frond end  alive for 10 sec..."
          # sleep 10

      - name: Checkout repo
        uses: actions/checkout@v4
       
      - name: Setup Node.js for frontend
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Get LocalTunnel Password
        run: |
          echo "ðŸ”‘ Getting password from LocalTunnel..."
          curl -s https://loca.lt/mytunnelpassword
          echo ""
          echo "ðŸ‘† Copy the password shown above"
       
      - name: Create frontend with injected backend URL
        run: |
          echo "ðŸŽ¨ Creating frontend with backend URL: ${{ needs.backend_server.outputs.backend_url }}"
          mkdir -p frontend
          sed "s|BACKEND_URL_PLACEHOLDER|${{ needs.backend_server.outputs.backend_url }}|g" frontend-template.html > frontend/index.html
          echo "âœ… Frontend created with injected URL"
       
      - name: Start frontend server
        id: start-frontend
        run: |
          echo "ðŸŒ Starting frontend server..."
          npx http-server frontend -p 3001 > frontend.log 2>&1 &
          sleep 5
          
          # Install localtunnel and create tunnel for frontend
          npm install -g localtunnel
          lt --port 3001 > tunnel.log 2>&1 &
          sleep 10
          
          frontend_url=$(grep -o 'https://[0-9a-z-]\+\.loca\.lt' tunnel.log | head -n1)
          echo "Frontend URL: $frontend_url"
          echo "url=$frontend_url" >> $GITHUB_OUTPUT
       
      - name: Test complete flow
        run: |
          echo "ðŸ”— Testing complete flow..."
          echo "Backend: ${{ needs.backend_server.outputs.backend_url }}/api"
          echo "Frontend: ${{ steps.start-frontend.outputs.url }}"
          echo ""
          echo "ðŸ“„ Frontend page content:"
          curl -s ${{ steps.start-frontend.outputs.url }} | head -n 30
          echo ""
          echo "âœ… You can visit: ${{ steps.start-frontend.outputs.url }}"
       
      - name: Keep frontend alive
        run: |
          echo "ðŸ”„ Keeping frontend alive for 5 minutes..."
          sleep 300